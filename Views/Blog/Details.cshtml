@model GreTutor.Models.Entities.BlogPost
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    Layout = "_Layout";
    ViewData["Title"] = Model.Title;
}

<!-- Page Banner Start -->
@await Html.PartialAsync("_PageBannerStart")
<!-- Page Banner End -->


<div class="container mt-5 d-flex justify-content-center">
    <div class="col-md-8 bg-white p-4 rounded shadow">
        <h2 class="text-center text-primary">@Html.Raw(Model.Title)</h2>
        <p class="text-center text-muted">Ngày: @Model.Created.ToString("dd/MM/yyyy")</p>
        <hr />
        <p class="lead">@Html.Raw(Model.Content)</p>

        <h4 class="mt-4">List of comments</h4>
        <div class="comment-section">
            @if (Model.Comments?.Any() ?? false)
            {
                <ul class="list-group">
                    @foreach (var comment in Model.Comments)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-primary">@(comment.User?.UserName ?? "Ẩn danh")</strong>
                                <p>@Html.Raw(comment.Content)</p>
                                <small class="text-muted">@comment.Created.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                            <div>
                                @if (User.Identity.IsAuthenticated && (User.Identity.Name == comment.User?.UserName ||
                                                        User.IsInRole("Staff")))
                                {
                                    <button class="btn btn-warning btn-sm" onclick="showEditForm(@comment.CommentId)">Edit</button>
                                    <form asp-action="Delete" asp-controller="Comment" method="post"
                                        onsubmit="return confirm('Are you sure you want to delete this comment?');"
                                        style="display: inline;">
                                        <input type="hidden" name="commentId" value="@comment.CommentId" />
                                        <input type="hidden" name="blogId" value="@Model.BlogId" />
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                }
                            </div>
                        </li>

                        <li id="edit-form-@comment.CommentId" class="list-group-item" style="display: none;">
                            <form asp-action="Edit" asp-controller="Comment" method="post">
                                <input type="hidden" name="CommentId" value="@comment.CommentId" />
                                <input type="hidden" name="blogId" value="@Model.BlogId" />
                                <textarea name="Content" class="form-control">@comment.Content</textarea>
                                <button type="submit" class="btn btn-primary btn-sm mt-2">Save</button>
                                <button type="button" class="btn btn-secondary btn-sm mt-2"
                                    onclick="hideEditForm(@comment.CommentId)">Cancel</button>
                            </form>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-center text-muted">No comments yet</p>
            }
        </div>

        @if (SignInManager.IsSignedIn(User))
        {
            <h4 class="mt-4">Add comment</h4>
            <form asp-action="Create" asp-controller="Comment" method="post" class="d-flex align-items-center">
                <input type="hidden" name="blogId" value="@Model.BlogId" />
                <textarea name="content" class="form-control me-2" required></textarea>
                <button type="submit" class="btn btn-success d-flex align-items-center justify-content-center"
                    style="width: 40px; height: 40px; border-radius: 50%;">
                    <i class="fas fa-paper-plane"></i> <!-- Font Awesome -->
                </button>
            </form>

            <!-- Thêm Font Awesome nếu chưa có -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

        }
        else
        {
            <p class="text-center"><a asp-controller="Account" asp-action="Login">Login</a> to comment.</p>
        }

        <div class="mt-4 text-center">
            <a href="~/Blog/HomeBlog" class="btn btn-secondary">Back to list</a>
        </div>
    </div>
</div>

<script>
    function showEditForm(commentId) {
        document.getElementById("edit-form-" + commentId).style.display = "block";
    }
    function hideEditForm(commentId) {
        document.getElementById("edit-form-" + commentId).style.display = "none";
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">